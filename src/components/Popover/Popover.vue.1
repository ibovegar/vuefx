<template>
  <span
    v-click-outside="forceShow ? '' : doClose"
    class="ks-popover"
    :style="{ width: width + 'px' }"
    >
    <transition
      name="popper-animation"
      @after-leave="doDestroy"
      >
      <span
        v-show="!disabled && showPopper"
        ref="popper"
        class="ks-popover__popper"
        :style="newOffset"
        >
        <slot></slot>
      </span>
    </transition>
    <slot name="trigger"></slot>
  </span>
</template>

<script>
import ClickOutside from '@/directives/click-outside'
import PopperMixin from '@/mixins/popper.js'
import { on, off } from '@/utils/helpers'

export default {
  name: 'ks-popover',

  directives: { ClickOutside },

  mixins: [ PopperMixin ],

  props: {
    width: Number,
    offset: Number
  },

  computed: {
    newOffset: function () {
      console.log(this.position)
      if (this.position === 'top') return { marginBottom : this.offset }
      if (this.position === 'bottom') return { marginTop: this.offset }
      if (this.position === 'left') return { marginRight: this.offset }
      if (this.position === 'right') return { marginLeft: this.offset }
    }
  },

  methods: {
    doShow () {
      this.showPopper = true

      this.$nextTick(() => {
        for (let el of this.$refs.popper.querySelectorAll('[close-popover]')) {
          on(el, 'click', this.doClose)
        }
      })
    },
    doClose () {
      if (this.showPopper) {
        for (let el of this.$refs.popper.querySelectorAll('[close-popover]')) {
          off(el, 'click', this.doClose)
        }
      }
      this.showPopper = false
    }
  },

  mounted () {
    let ref = this.reference || this.$slots.trigger[0].elm
    this.doMount('popover', this.$refs.popper, ref)
  }
}
</script>

<style>
.popper-animation-enter-active {
  transition: all 0.3s ease;
}
.popper-animation-leave-active {
  transition: all 0.2s cubic-bezier(1.0, 0.5, 0.8, 1.0);
}
.popper-animation-enter, .popper-animation-leave-to {
  transform: translateY(-16px);
  opacity: 0;
}

.ks-popover {
  width: auto;

  &__popper {
    width: inherit;
    z-index: var(--z-index--popover);
    box-shadow: var(--box-shadow--medium);
    border-radius: var(--border-radius--medium);
    border: 1px solid var(--color--border);
    background: var(--color--flat);
    @mixin font-size 14;
  }
}
</style>
